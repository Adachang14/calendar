<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f8f8f8; }
    h1 { text-align: center; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; max-width: 800px; margin: 0 auto 10px auto; }
    .calendar-nav { display: flex; align-items: center; gap: 10px; }
    .calendar-nav button { padding: 5px 10px; border: none; background: #ccc; border-radius: 5px; cursor: pointer; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; max-width: 600px; margin: auto; }
    .day, .header { padding: 10px; background: white; text-align: center; border-radius: 8px; cursor: pointer; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .header { font-weight: bold; background: #e0e0e0; cursor: default; }
    .today { background: #ffecb3 !important; }
    .selected { background: #ffcccc !important; }
    .note-box { margin-top: 10px; }
    .note-input { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-top: 5px; }
    .all-notes { max-width: 600px; margin: 30px auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .all-notes h3 { margin-top: 0; }
    .note-entry { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .legend-container { position: absolute; top: 10px; right: 10px; text-align: right; font-size: 14px; }
    .legend div { margin: 2px 0; }
    .legend span { display: inline-block; width: 16px; height: 16px; border-radius: 3px; margin-right: 6px; vertical-align: middle; }
    .red { background: #ffcccc; }
    .white { background: #ffffff; border: 1px solid #ccc; }
    .yellow { background: #ffecb3; }
    .warning { color: red; font-size: 14px; font-weight: bold; margin-top: 5px; }
    .select-dropdown select { padding: 6px 12px; border-radius: 5px; border: 1px solid #ccc; background: #fff; font-size: 14px; }
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
    #sync-btn { display: block; margin: 10px auto; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #sync-btn:hover { background: #0056b3; }
  </style>
</head>
<body>

<h1>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Online Sync)</h1>

<button id="sync-btn" onclick="migrateData()">üîÑ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô Cloud</button>

<div class="calendar-header">
  <div class="calendar-nav">
    <div class="select-dropdown">
      <select id="month-selector" onchange="selectMonth(event)">
        <option value="0">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
        <option value="1">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
        <option value="2">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
        <option value="3">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
        <option value="4">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
        <option value="5">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
        <option value="6">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
        <option value="7">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
        <option value="8">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
        <option value="9">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
        <option value="10">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
        <option value="11">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
      </select>
    </div>
    <div class="select-dropdown">
      <select id="year-selector" onchange="selectYear(event)">
        <option value="2568">2568</option>
        <option value="2569">2569</option>
        <option value="2570">2570</option>
        <option value="2571">2571</option>
        <option value="2572">2572</option>
        <option value="2573">2573</option>
      </select>
    </div>
    <button onclick="changeMonth(-1)">‚óÄÔ∏è ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
    <span id="current-month"></span>
    <button onclick="changeMonth(1)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂Ô∏è</button>
  </div>
</div>

<div id="calendar" class="calendar"></div>

<div class="note-box" style="max-width:600px;margin:auto;display:none;">
  <h3 id="note-date"></h3>
  <textarea id="note-input" class="note-input" rows="4" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ..."></textarea>
</div>

<div class="all-notes" id="all-notes">
  <h3>‡πÇ‡∏ô‡πä‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
  <div id="notes-list"></div>
</div>

<div class="legend-container">
  <div><span class="red"></span>‡∏™‡∏µ‡πÅ‡∏î‡∏á = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ö‡πÄ‡∏Å‡πà‡∏≤</div>
  <div><span class="white"></span>‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
  <div><span class="yellow"></span>‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á = ‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
  <div class="warning">13 ‡πÄ‡∏°‡∏©‡∏≤ ‡∏ñ‡∏∂‡∏á 6 ‡∏û‡∏§‡∏©‡∏†‡∏≤ 68 ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgYM7DIII0K7McYcqD9pvkdAbsWRcAc5A",
    authDomain: "calendar-8e62f.firebaseapp.com",
    databaseURL: "https://calendar-8e62f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "calendar-8e62f",
    storageBucket: "calendar-8e62f.firebasestorage.app",
    messagingSenderId: "257469845582",
    appId: "1:257469845582:web:3acad4d40611e6a711f31f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud
  let cloudData = {};

  const calendarEl = document.getElementById('calendar');
  const noteBox = document.querySelector('.note-box');
  const noteDate = document.getElementById('note-date');
  const noteInput = document.getElementById('note-input');
  const currentMonthLabel = document.getElementById('current-month');
  const notesListEl = document.getElementById('notes-list');
  let selectedDateKey = '';
  let viewDate = new Date();

  const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  const days = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'];

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
  onValue(ref(db, 'calendar_data/'), (snapshot) => {
    cloudData = snapshot.val() || {};
    renderCalendar(viewDate);
  });

  window.renderCalendar = function(date) {
    const yearCE = date.getFullYear();
    const yearBE = yearCE + 543;
    const month = date.getMonth();
    const today = new Date();

    calendarEl.innerHTML = '';
    currentMonthLabel.innerText = `${monthNames[month]} ${yearBE}`;
    
    document.getElementById('month-selector').value = month;
    document.getElementById('year-selector').value = yearBE;

    for (let d of days) {
      let cell = document.createElement('div');
      cell.className = 'header';
      cell.innerText = d;
      calendarEl.appendChild(cell);
    }

    const firstDay = new Date(yearCE, month, 1).getDay();
    const lastDate = new Date(yearCE, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      calendarEl.appendChild(document.createElement('div'));
    }

    for (let d = 1; d <= lastDate; d++) {
      let cell = document.createElement('div');
      cell.className = 'day';
      const key = `${yearBE}-${month + 1}-${d}`;
      
      if (d === today.getDate() && month === today.getMonth() && yearCE === today.getFullYear()) {
        cell.classList.add('today');
      }

      if (cloudData[key] && cloudData[key].selected) {
        cell.classList.add('selected');
      }

      cell.innerText = d;
      cell.onclick = () => {
        const isSelected = !cell.classList.contains('selected');
        update(ref(db, 'calendar_data/' + key), { selected: isSelected });
        openNote(yearBE, month, d);
      };
      calendarEl.appendChild(cell);
    }
    renderAllNotes(yearBE, month);
  }

  window.openNote = function(y, m, d) {
    selectedDateKey = `${y}-${m + 1}-${d}`;
    noteBox.style.display = 'block';
    noteDate.innerText = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d} ${monthNames[m]} ${y}`;
    noteInput.value = (cloudData[selectedDateKey] && cloudData[selectedDateKey].note) ? cloudData[selectedDateKey].note : '';
  }

  noteInput.oninput = () => {
    if (selectedDateKey) {
      update(ref(db, 'calendar_data/' + selectedDateKey), { note: noteInput.value });
    }
  };

  window.changeMonth = (offset) => {
    viewDate.setMonth(viewDate.getMonth() + offset);
    renderCalendar(viewDate);
  };

  window.selectMonth = (e) => {
    viewDate.setMonth(parseInt(e.target.value));
    renderCalendar(viewDate);
  };

  window.selectYear = (e) => {
    viewDate.setFullYear(parseInt(e.target.value) - 543);
    renderCalendar(viewDate);
  };

  function renderAllNotes(yearBE, month) {
    notesListEl.innerHTML = '';
    const entries = [];
    for (let d = 1; d <= 31; d++) {
      const key = `${yearBE}-${month + 1}-${d}`;
      if (cloudData[key] && cloudData[key].note) {
        entries.push({ day: d, text: cloudData[key].note });
      }
    }
    entries.forEach(entry => {
      const div = document.createElement('div');
      div.className = 'note-entry';
      div.innerText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${entry.day}: ${entry.text}`;
      notesListEl.appendChild(div);
    });
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LocalStorage ‡∏Ç‡∏∂‡πâ‡∏ô Cloud (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
  window.migrateData = async function() {
    if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 6-7 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ç‡∏∂‡πâ‡∏ô Cloud ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
    
    let count = 0;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      const value = localStorage.getItem(key);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠ Key ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 2568-1-1) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (key.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
        await update(ref(db, 'calendar_data/' + key), { note: value });
        count++;
      }
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ‡πÅ‡∏î‡∏á
      if (key.endsWith('-selected')) {
        const realKey = key.replace('-selected', '');
        await update(ref(db, 'calendar_data/' + realKey), { selected: true });
        count++;
      }
    }
    alert(`‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö`);
    document.getElementById('sync-btn').style.display = 'none';
  };

</script>
</body>
</html>
